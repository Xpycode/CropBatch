# CropBatch Code Review — 2025-12-28 21:43:30Z

## Critical Issues

1. **Top/Bottom crop coordinates are inverted**  
   - **Location**: `CropBatch/Services/ImageCropService.swift:332-338`  
   - **Problem**: The crop rectangle is built with `y: settings.cropTop` even though CoreGraphics expects the origin at the bottom-left. Cropping 50px from the “top” actually trims the bottom (and vice‑versa), yielding exports that don’t match the on-screen overlay and making presets inaccurate.  
   - **Recommendation**: Set `y` to `settings.cropBottom` (distance from the bottom edge) and keep the height subtraction for the top crop, or flip the coordinate system consistently before cropping.

2. **Entire batch pipeline runs on the main actor**  
   - **Location**: `CropBatch/Services/ImageCropService.swift:424-495`  
   - **Problem**: `batchCrop` is marked `@MainActor`, so every per-image transform, blur, crop, resize, and disk write runs on the UI thread. Exporting even a handful of large screenshots will freeze the SwiftUI interface (and the folder watcher) for seconds, and CLI mode suffers the same serialization.  
   - **Recommendation**: Remove the `@MainActor` annotation, perform the heavy work on a background task/queue, and marshal only UI updates (progress closure) back to the main actor.

3. **Batch review previews omit transforms, blur regions, and resizing**  
   - **Location**: `CropBatch/Views/BatchReviewView.swift:150-175`  
   - **Problem**: Preview generation only calls `ImageCropService.crop` with the current crop settings. Any rotation/flip (`imageTransforms`), blur regions, or resize/export format adjustments are ignored, so the confirmation sheet can show approvals for images that will later be rotated, resized, or blurred differently.  
   - **Recommendation**: Reuse the same pipeline as export (or at least apply transforms/blurs/resizes) when building `PreviewItem` so the operator reviews the actual output.

4. **No protection against filename collisions across inputs**  
   - **Location**: `CropBatch/Models/ExportSettings.swift:144-190` and `CropBatch/Services/ImageCropService.swift:445-492`  
   - **Problem**: The overwrite check only compares each output path to its original input (`wouldOverwriteOriginal`). If two different inputs resolve to the same target name (e.g., custom rename pattern `"final"`, same `{counter}` from different folders, or identical originals dropped from separate directories), later iterations overwrite the earlier exports silently.  
   - **Recommendation**: As part of the pre-check loop, build the full set of planned destination URLs and fail fast (or auto-disambiguate) when duplicates exist.

## Major Issues

5. **Export button is disabled for pure format conversions**  
   - **Location**: `CropBatch/Models/AppState.swift:471-479` and `CropBatch/Views/ActionButtonsView.swift:117-137`  
   - **Problem**: `canExport` only turns true when there is a crop, blur, transform, resize, or rename pattern. Changing the export format (e.g., JPEG→PNG) or toggling `preserveOriginalFormat` does not count, so the “Export” button stays disabled even though a new file would be created with a different format/suffix. Users currently have to enable an irrelevant rename pattern just to convert formats.  
   - **Recommendation**: Include `exportSettings.preserveOriginalFormat == false && exportSettings.format != originalFormat` (or simply allow exports whenever the destination differs) so format conversions aren’t blocked.

6. **UI detection reads the wrong edge pixels**  
   - **Location**: `CropBatch/Services/UIDetector.swift:77-109`  
   - **Problem**: The bitmap context is drawn without flipping, so row `y = 0` corresponds to the bottom of the screenshot. The detector treats `edge == .top` as `y = 0`, meaning top detection is actually sampling the bottom edge and vice versa. Suggested crop values therefore describe the wrong edge, and applying them trims the opposite side.  
   - **Recommendation**: Either flip the context (`context.translate/scale`) when drawing or swap the sampled rows so “top” starts from `height - 1` while “bottom” starts from `0`.

7. **Crop text fields allow invalid/negative dimensions**  
   - **Location**: `CropBatch/Views/CropSettingsView.swift:11-38` & `CropBatch/Views/CropSettingsView.swift:124-143`  
   - **Problem**: Text entry writes raw integers straight into `cropSettings` (and linked edges copy them) with no clamping against the active image’s width/height. Entering values that exceed the image size or negative numbers produces a negative crop rectangle, leading to `ImageCropError.invalidCropRegion` during preview/export and confusing overlay rendering.  
   - **Recommendation**: Validate each edit via `AppState.adjustCrop` or clamp values against the current image dimensions before committing, and sanitize linked-edge propagation as well.

