# Code Review Report

Date: 2026-01-04 23:03:53

## Scope
- CropBatch/Models/AppState.swift
- CropBatch/Models/ImageManager.swift
- CropBatch/Services/ImageCropService.swift
- CropBatch/Services/ExportCoordinator.swift
- CropBatch/Models/ExportSettings.swift
- CropBatch/Services/FolderWatcher.swift
- CropBatch/Models/NormalizedGeometry.swift
- CropBatch/Views/CropEditorView.swift

## Findings
- High: Blur regions are not transformed to match rotation/flip in the rename-on-conflict path, so blurred areas drift when transforms are active. The batch path applies transforms, but the per-image conflict path does not. See `CropBatch/Models/AppState.swift:493`.
- High: Importing via NSOpenPanel never propagates auto-detected export format or preset changes back to AppState because `showImportPanel` mutates local copies only. This makes drag-and-drop and panel import behave differently. See `CropBatch/Models/ImageManager.swift:125`.
- Medium: Existing-file conflict checks ignore rename pattern indexing and always use index 0, so batch exports with patterns can undercount conflicts and skip the overwrite dialog. See `CropBatch/Services/ExportCoordinator.swift:91`.
- Medium: Crop math is documented as top-left based but sent directly to `CGImage.cropping` without flipping Y, which conflicts with the rest of the coordinate system comments and normalized conversions. This can crop from the wrong edge. See `CropBatch/Services/ImageCropService.swift:555`.
- Medium: Blur region rendering uses `NSImage.size` when converting normalized regions to pixels and creating a CGContext. If the image has a Retina scale mismatch, blur placement will be offset because regions are normalized against pixel sizes. See `CropBatch/Services/ImageCropService.swift:287`.
- Low: Export profiles serialize only format/quality/suffix/resize/rename, so watermark settings are silently dropped when saving or restoring profiles. See `CropBatch/Models/ExportSettings.swift:340`.
- Low: Folder watcher exports do not guard against overwriting existing files or overwriting originals if output matches the watched folder with empty suffix. This can cause silent data loss. See `CropBatch/Services/FolderWatcher.swift:125`.

## Proposed Fixes
- For the rename-on-conflict path, reuse the same pipeline as `ImageCropService.processSingleImage` (or at least transform blur regions with `region.normalizedRect.applyingTransform(transform)`) before `applyBlurRegions`, matching the batch path. See `CropBatch/Models/AppState.swift:493`.
- Refactor `showImportPanel` to update AppState directly (e.g., move panel ownership to AppState or add a completion handler) rather than mutating local copies. The current inout values never escape the closure. See `CropBatch/Models/ImageManager.swift:125`.
- Replace `processImages` conflict counting with `ExportSettings.findExistingFiles(items:)` after setting `settings.outputDirectory = .custom(outputDirectory)`, so index-based rename patterns are respected. See `CropBatch/Services/ExportCoordinator.swift:91`.
- In `ImageCropService.crop`, convert top-left crop to CGImage coords: `let cropY = originalHeight - settings.cropTop - cropHeight`, or compute via `NormalizedRect.cropArea(...).toCGImageRect(...)` to align with the rest of the coordinate system helpers. See `CropBatch/Services/ImageCropService.swift:555`.
- In `applyBlurRegions`, base `imageSize` and CGContext dimensions on the CGImage pixel size (cgImage.width/height) rather than `NSImage.size`, and return an NSImage sized to those pixels. See `CropBatch/Services/ImageCropService.swift:287`.
- Extend `ExportSettingsCodable` to include `watermarkSettings`, and restore it in `toExportSettings()` so profiles persist watermark config. See `CropBatch/Models/ExportSettings.swift:340`.
- Add overwrite checks in `FolderWatcher.processNewFile` using `exportSettings.wouldOverwriteOriginal` + `findExistingFiles`; either append numeric suffixes or skip with an error message/notification. See `CropBatch/Services/FolderWatcher.swift:125`.

## Open Questions
- Should rotation/flip be supported in UI now, or remain shelved? The blur-transform mismatch is currently masked if transforms are disabled.
- Are export profiles intended to persist watermark settings, or is that intentionally excluded?

## Testing Gaps
- No automated tests found. The image pipeline paths (batch, rename-on-conflict, folder watcher, CLI) should have basic fixtures to validate crop alignment, blur placement, and filename collision handling.
